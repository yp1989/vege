<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.vcooline.crm.common.mapper.CrmBusinessMapper">
    <resultMap id="BaseResultMap" type="com.vcooline.crm.common.model.CrmBusiness">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Wed Jul 22 10:16:27 CST 2015.
        -->
        <id column="id" jdbcType="BIGINT" property="id"/>
        <result column="clue_id" jdbcType="BIGINT" property="clueId"/>
        <result column="busi_number" jdbcType="VARCHAR" property="busiNumber"/>
        <result column="num_code" jdbcType="INTEGER" property="numCode"/>
        <result column="busi_regitime" jdbcType="TIMESTAMP" property="busiRegitime"/>
        <result column="busi_status" jdbcType="TINYINT" property="busiStatus"/>
        <result column="busi_source" jdbcType="TINYINT" property="busiSource"/>
        <result column="owner" jdbcType="BIGINT" property="owner"/>
        <result column="owner_name" jdbcType="VARCHAR" property="ownerName"/>
        <result column="admin_id" jdbcType="BIGINT" property="adminId"/>
        <result column="admin_name" jdbcType="VARCHAR" property="adminName"/>
        <result column="busi_type" jdbcType="BIT" property="busiType"/>
        <result column="remark" jdbcType="VARCHAR" property="remark"/>
        <result column="return_change_remark" jdbcType="VARCHAR" property="returnChangeRemark"/>
        <result column="is_del" jdbcType="BIT" property="isDel"/>
        <result column="create_time" jdbcType="TIMESTAMP" property="createTime"/>
        <result column="update_time" jdbcType="TIMESTAMP" property="updateTime"/>
        <result column="allot_time" jdbcType="TIMESTAMP" property="allotTime"/>
    </resultMap>
    <sql id="Base_Column_List">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Wed Jul 22 10:16:27 CST 2015.
        -->
        id, clue_id, busi_number, num_code, busi_regitime, busi_status, busi_source, owner,
        owner_name,admin_id,admin_name, busi_type,remark, return_change_remark,is_del, create_time, update_time,
        allot_time
    </sql>

    <sql id="Base_Query_Connection">
        <if test="clueId != null">
            AND clue_id = #{clueId,jdbcType=BIGINT}
        </if>
        <if test="busiNumber != null">
            AND busi_number = #{busiNumber,jdbcType=VARCHAR}
        </if>
        <if test="numCode != null">
            AND num_code = #{numCode,jdbcType=TINYINT}
        </if>
        <if test="busiRegitime != null">
            AND busi_regitime = #{busiRegitime,jdbcType=TIMESTAMP}
        </if>
        <if test="busiStatus != null">
            AND busi_status = #{busiStatus,jdbcType=TINYINT}
        </if>
        <if test="busiSource != null">
            AND busi_source = #{busiSource,jdbcType=TINYINT}
        </if>
        <if test="owner != null">
            AND owner = #{owner,jdbcType=BIGINT}
        </if>
        <if test="ownerName != null">
            AND owner_name = #{ownerName,jdbcType=VARCHAR}
        </if>
        <if test="adminId != null">
            AND admin_id = #{adminId,jdbcType=BIGINT}
        </if>
        <if test="adminName != null">
            AND admin_name = #{adminName,jdbcType=VARCHAR}
        </if>
        <if test="busiType != null">
            AND busi_type = #{busiType,jdbcType=BIT}
        </if>
        <if test="remark != null">
            AND remark = #{remark,jdbcType=VARCHAR}
        </if>
        <if test="returnChangeRemark != null">
            AND return_change_remark = #{returnChangeRemark,jdbcType=VARCHAR}
        </if>
        <if test="isDel != null">
            AND is_del = #{isDel,jdbcType=BIT}
        </if>
        <if test="createTime != null">
            AND create_time = #{createTime,jdbcType=TIMESTAMP}
        </if>
        <if test="updateTime != null">
            AND update_time = #{updateTime,jdbcType=TIMESTAMP}
        </if>
        <if test="allotTime != null">
            AND allot_time = #{allotTime,jdbcType=TIMESTAMP}
        </if>
    </sql>
    <select id="selectByPrimaryKey" parameterType="java.lang.Long" resultMap="BaseResultMap">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Wed Jul 22 10:16:27 CST 2015.
        -->
        select
        <include refid="Base_Column_List"/>
        from crm_business
        where id = #{id,jdbcType=BIGINT}
    </select>
    <!--根据条件查询商机-->
    <select id="selectByParam" parameterType="com.vcooline.crm.common.model.CrmBusiness" resultMap="BaseResultMap">
        select
        <include refid="Base_Column_List"/>
        from crm_business
        where 1=1
        <include refid="Base_Query_Connection"/>
        ORDER BY create_time DESC
    </select>
    <delete id="deleteByPrimaryKey" parameterType="java.lang.Long">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Wed Jul 22 10:16:27 CST 2015.
        -->
        delete from crm_business
        where id = #{id,jdbcType=BIGINT}
    </delete>
    <insert id="insert" parameterType="com.vcooline.crm.common.model.CrmBusiness" useGeneratedKeys="true"
            keyProperty="id">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Wed Jul 22 10:16:27 CST 2015.
        -->
        insert into crm_business (id, clue_id, busi_number,
        num_code, busi_regitime, busi_status,
        busi_source, owner, owner_name,admin_id,admin_name,
        busi_type,remark, is_del, create_time,
        update_time, allot_time)
        values (#{id,jdbcType=BIGINT}, #{clueId,jdbcType=BIGINT}, #{busiNumber,jdbcType=VARCHAR},
        #{numCode,jdbcType=TINYINT}, #{busiRegitime,jdbcType=TIMESTAMP}, #{busiStatus,jdbcType=TINYINT},
        #{busiSource,jdbcType=TINYINT}, #{owner,jdbcType=BIGINT}, #{ownerName,jdbcType=VARCHAR},
        #{adminId,jdbcType=BIGINT}, #{adminName,jdbcType=VARCHAR},
        #{busiType,jdbcType=BIT}, #{remark,jdbcType=VARCHAR},#{isDel,jdbcType=BIT}, #{createTime,jdbcType=TIMESTAMP},
        #{updateTime,jdbcType=TIMESTAMP}, #{allotTime,jdbcType=TIMESTAMP})
    </insert>
    <insert id="insertSelective" parameterType="com.vcooline.crm.common.model.CrmBusiness" useGeneratedKeys="true"
            keyProperty="id">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Wed Jul 22 10:16:27 CST 2015.
        -->
        insert into crm_business
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="id != null">
                id,
            </if>
            <if test="clueId != null">
                clue_id,
            </if>
            <if test="busiNumber != null">
                busi_number,
            </if>
            <if test="numCode != null">
                num_code,
            </if>
            <if test="busiRegitime != null">
                busi_regitime,
            </if>
            <if test="busiStatus != null">
                busi_status,
            </if>
            <if test="busiSource != null">
                busi_source,
            </if>
            <if test="owner != null">
                owner,
            </if>
            <if test="ownerName != null">
                owner_name,
            </if>
            <if test="adminId != null">
                admin_id,
            </if>
            <if test="adminName != null">
                admin_name,
            </if>
            <if test="busiType != null">
                busi_type,
            </if>
            <if test="remark != null">
                remark,
            </if>
            <if test="isDel != null">
                is_del,
            </if>
            <if test="createTime != null">
                create_time,
            </if>
            <if test="updateTime != null">
                update_time,
            </if>
            <if test="allotTime != null">
                allot_time,
            </if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="id != null">
                #{id,jdbcType=BIGINT},
            </if>
            <if test="clueId != null">
                #{clueId,jdbcType=BIGINT},
            </if>
            <if test="busiNumber != null">
                #{busiNumber,jdbcType=VARCHAR},
            </if>
            <if test="numCode != null">
                #{numCode,jdbcType=TINYINT},
            </if>
            <if test="busiRegitime != null">
                #{busiRegitime,jdbcType=TIMESTAMP},
            </if>
            <if test="busiStatus != null">
                #{busiStatus,jdbcType=TINYINT},
            </if>
            <if test="busiSource != null">
                #{busiSource,jdbcType=TINYINT},
            </if>
            <if test="owner != null">
                #{owner,jdbcType=BIGINT},
            </if>
            <if test="ownerName != null">
                #{ownerName,jdbcType=VARCHAR},
            </if>
            <if test="adminId != null">
                #{adminId,jdbcType=BIGINT},
            </if>
            <if test="adminName != null">
                #{adminName,jdbcType=VARCHAR},
            </if>
            <if test="busiType != null">
                #{busiType,jdbcType=BIT},
            </if>
            <if test="remark != null">
                #{remark,jdbcType=VARCHAR},
            </if>
            <if test="isDel != null">
                #{isDel,jdbcType=BIT},
            </if>
            <if test="createTime != null">
                #{createTime,jdbcType=TIMESTAMP},
            </if>
            <if test="updateTime != null">
                #{updateTime,jdbcType=TIMESTAMP},
            </if>
            <if test="allotTime != null">
                #{allotTime,jdbcType=TIMESTAMP},
            </if>
        </trim>
    </insert>
    <update id="updateByPrimaryKeySelective" parameterType="com.vcooline.crm.common.model.CrmBusiness">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Wed Jul 22 10:16:27 CST 2015.
        -->
        update crm_business
        <set>
            <if test="clueId != null">
                clue_id = #{clueId,jdbcType=BIGINT},
            </if>
            <if test="busiNumber != null">
                busi_number = #{busiNumber,jdbcType=VARCHAR},
            </if>
            <if test="numCode != null">
                num_code = #{numCode,jdbcType=TINYINT},
            </if>
            <if test="busiRegitime != null">
                busi_regitime = #{busiRegitime,jdbcType=TIMESTAMP},
            </if>
            <if test="busiStatus != null">
                busi_status = #{busiStatus,jdbcType=TINYINT},
            </if>
            <if test="busiSource != null">
                busi_source = #{busiSource,jdbcType=TINYINT},
            </if>
            <if test="owner != null">
                owner = #{owner,jdbcType=BIGINT},
            </if>
            <if test="ownerName != null">
                owner_name = #{ownerName,jdbcType=VARCHAR},
            </if>
            <if test="adminId != null">
                admin_id = #{adminId,jdbcType=BIGINT},
            </if>
            <if test="adminName != null">
                admin_name = #{adminName,jdbcType=VARCHAR},
            </if>
            <if test="busiType != null">
                busi_type = #{busiType,jdbcType=BIT},
            </if>
            <if test="remark != null">
                remark = #{remark,jdbcType=VARCHAR},
            </if>
            <if test="returnChangeRemark != null">
                return_change_remark = #{returnChangeRemark,jdbcType=VARCHAR},
            </if>
            <if test="isDel != null">
                is_del = #{isDel,jdbcType=BIT},
            </if>
            <if test="createTime != null">
                create_time = #{createTime,jdbcType=TIMESTAMP},
            </if>
            <if test="updateTime != null">
                update_time = #{updateTime,jdbcType=TIMESTAMP},
            </if>
            <if test="allotTime != null">
                allot_time = #{allotTime,jdbcType=TIMESTAMP},
            </if>
        </set>
        where id = #{id,jdbcType=BIGINT}
    </update>
    <update id="updateByPrimaryKey" parameterType="com.vcooline.crm.common.model.CrmBusiness">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Wed Jul 22 10:16:27 CST 2015.
        -->
        update crm_business
        set clue_id = #{clueId,jdbcType=BIGINT},
        busi_number = #{busiNumber,jdbcType=VARCHAR},
        num_code = #{numCode,jdbcType=TINYINT},
        busi_regitime = #{busiRegitime,jdbcType=TIMESTAMP},
        busi_status = #{busiStatus,jdbcType=TINYINT},
        busi_source = #{busiSource,jdbcType=TINYINT},
        owner = #{owner,jdbcType=BIGINT},
        owner_name = #{ownerName,jdbcType=VARCHAR},
        admin_id = #{adminId,jdbcType=BIGINT},
        admin_name = #{adminName,jdbcType=VARCHAR},
        busi_type = #{busiType,jdbcType=BIT},
        remark = #{remark,jdbcType=VARCHAR},
        is_del = #{isDel,jdbcType=BIT},
        create_time = #{createTime,jdbcType=TIMESTAMP},
        update_time = #{updateTime,jdbcType=TIMESTAMP},
        allot_time = #{allotTime,jdbcType=TIMESTAMP}
        where id = #{id,jdbcType=BIGINT}
    </update>

    <!--获取最大自增码-->
    <select id="getMaxNumCode" resultType="java.lang.Integer">
        SELECT max(num_code)
        FROM crm_business cb
        WHERE
        DATE_FORMAT(cb.create_time, '%Y-%m') = DATE_FORMAT(NOW(), '%Y-%m')
    </select>

    <!--分页查询-->
    <select id="queryCrmBusieForPage" parameterType="com.vcooline.crm.common.model.Page" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        , (
        SELECT
        cc.cust_name
        FROM
        crm_clue cc
        WHERE
        cc.id = cb.clue_id
        ) as custName
        FROM
        crm_business cb
        WHERE 1=1
        <if test="page.params.custName != null">
            AND EXISTS (
            SELECT
            cc.cust_name
            FROM
            crm_clue cc
            WHERE
            cc.id = cb.clue_id
            AND cc.cust_name LIKE '%${page.params.custName}%'
            )
        </if>
        <if test="page.params.callBargain != null">
            AND EXISTS (
            SELECT
            cbp.id
            FROM
            crm_busi_product cbp
            WHERE
            cbp.busi_id = cb.id
            AND cbp.prod_version_id = #{page.params.callBargain,jdbcType=BIGINT}
            )
        </if>
        <if test="page.params.createTimestart != null">
            AND cb.create_time &gt;= #{page.params.createTimestart,jdbcType=TIMESTAMP}
        </if>
        <if test="page.params.createTimeend != null">
            AND cb.create_time &lt;= #{page.params.createTimeend,jdbcType=TIMESTAMP}
        </if>
        <if test="page.params.busiStatus != null">
            AND cb.busi_status = #{page.params.busiStatus,jdbcType=TINYINT}
        </if>
        <if test="page.params.busiSource != null">
            AND cb.busi_source = #{page.params.busiSource,jdbcType=TINYINT}
        </if>
        <if test="page.params.busiType != null">
            AND cb.busi_type = #{page.params.busiType,jdbcType=BIT}
        </if>
        <if test="page.params.isDepManager == 0">
            <if test="page.params.owner != null">
                AND cb.owner = #{page.params.owner,jdbcType=BIGINT}
            </if>
        </if>
        <if test="page.params.isDepManager == 1">
            AND cb.owner IN (
            SELECT
            cad.id
            FROM
            crm_admin cad
            WHERE
            FIND_IN_SET(
            cad.admin_dep,getChildList (#{page.params.owner,jdbcType=BIGINT})
            )
            )
        </if>
        AND cb.is_del = 0
        ORDER BY cb.create_time DESC
    </select>
</mapper>