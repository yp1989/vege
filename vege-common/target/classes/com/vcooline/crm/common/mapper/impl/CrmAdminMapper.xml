<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.vcooline.crm.common.mapper.CrmAdminMapper">
  <resultMap id="BaseResultMap" type="com.vcooline.crm.common.model.CrmAdmin">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Jul 16 15:20:21 CST 2015.
    -->
    <id column="id" jdbcType="BIGINT" property="id" />
    <result column="admin_name" jdbcType="VARCHAR" property="adminName" />
    <result column="admin_password" jdbcType="VARCHAR" property="adminPassword" />
    <result column="admin_status" jdbcType="TINYINT" property="adminStatus" />
    <result column="admin_job" jdbcType="VARCHAR" property="adminJob" />
    <result column="admin_real_name" jdbcType="VARCHAR" property="adminRealName" />
    <result column="admin_phone" jdbcType="VARCHAR" property="adminPhone" />
    <result column="admin_dep" jdbcType="BIGINT" property="adminDep" />
    <result column="is_dep_manager" jdbcType="TINYINT" property="isDepManager" />
    <result column="admin_last_time" jdbcType="TIMESTAMP" property="adminLastTime" />
    <result column="is_del" jdbcType="BIT" property="isDel" />
    <result column="create_time" jdbcType="TIMESTAMP" property="createTime" />
    <result column="update_time" jdbcType="TIMESTAMP" property="updateTime" />
    <result column="dep_name" jdbcType="VARCHAR" property="depName" />
    <result column="role_id" jdbcType="BIGINT" property="role_id" />
    <result column="role_type" jdbcType="TINYINT" property="roleType" />
  </resultMap>
   
   <!-- 查询获取所有管理员和管理员对应的角色（一对多） -->
  <resultMap id="resultMap" type="com.vcooline.crm.common.model.CrmAdmin">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Jul 16 15:20:21 CST 2015.
    -->
    <id column="id" jdbcType="BIGINT" property="id" />
    <result column="admin_name" jdbcType="VARCHAR" property="adminName" />
    <result column="admin_password" jdbcType="VARCHAR" property="adminPassword" />
    <result column="admin_status" jdbcType="TINYINT" property="adminStatus" />
    <result column="admin_job" jdbcType="VARCHAR" property="adminJob" />
    <result column="admin_real_name" jdbcType="VARCHAR" property="adminRealName" />
    <result column="admin_phone" jdbcType="VARCHAR" property="adminPhone" />
    <result column="admin_dep" jdbcType="BIGINT" property="adminDep" />
    <result column="is_dep_manager" jdbcType="TINYINT" property="isDepManager" />
    <result column="admin_last_time" jdbcType="TIMESTAMP" property="adminLastTime" />
    <result column="is_del" jdbcType="BIT" property="isDel" />
    <result column="create_time" jdbcType="TIMESTAMP" property="createTime" />
    <result column="update_time" jdbcType="TIMESTAMP" property="updateTime" />
    <collection property="roleList" ofType="com.vcooline.crm.common.model.CrmRole">
        <result column="role_name" jdbcType="VARCHAR" property="roleName" />
    </collection>
  </resultMap>
  <sql id="Base_Column_List">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Jul 16 15:20:21 CST 2015.
    -->
    id, admin_name, admin_password, admin_status, admin_job, admin_real_name, admin_phone, 
    admin_dep, is_dep_manager, admin_last_time, is_del, create_time, update_time
  </sql>
  <select id="selectByPrimaryKey" parameterType="java.lang.Long" resultMap="BaseResultMap">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Jul 16 15:20:21 CST 2015.
    -->
      SELECT A.*,B.role_id AS ROLE_ID FROM crm_admin A 
                INNER JOIN crm_admin_role B on A.id = B.admin_id 
             WHERE A.ID = #{id} AND A.is_del = 0 AND B.is_del = 0 AND A.admin_status = 1
  </select>
  <delete id="deleteByPrimaryKey" parameterType="java.lang.Long">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Jul 16 15:20:21 CST 2015.
    -->
    delete from crm_admin
    where id = #{id,jdbcType=BIGINT}
  </delete>
  <insert id="insert" parameterType="com.vcooline.crm.common.model.CrmAdmin">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Jul 16 15:20:21 CST 2015.
    -->
    insert into crm_admin (id, admin_name, admin_password, 
      admin_status, admin_job, admin_real_name, 
      admin_phone, admin_dep, is_dep_manager, 
      admin_last_time, is_del, create_time, 
      update_time)
    values (#{id,jdbcType=BIGINT}, #{adminName,jdbcType=VARCHAR}, #{adminPassword,jdbcType=VARCHAR}, 
      #{adminStatus,jdbcType=TINYINT}, #{adminJob,jdbcType=VARCHAR}, #{adminRealName,jdbcType=VARCHAR}, 
      #{adminPhone,jdbcType=VARCHAR}, #{adminDep,jdbcType=BIGINT}, #{isDepManager,jdbcType=TINYINT}, 
      #{adminLastTime,jdbcType=TIMESTAMP}, #{isDel,jdbcType=BIT}, #{createTime,jdbcType=TIMESTAMP}, 
      #{updateTime,jdbcType=TIMESTAMP})
  </insert>
  <insert id="insertSelective" parameterType="com.vcooline.crm.common.model.CrmAdmin" useGeneratedKeys="true" keyProperty="id">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Jul 16 15:20:21 CST 2015.
    -->
    insert into crm_admin
    <trim prefix="(" suffix=")" suffixOverrides=",">
      <if test="id != null">
        id,
      </if>
      <if test="adminName != null">
        admin_name,
      </if>
      <if test="adminPassword != null">
        admin_password,
      </if>
      <if test="adminStatus != null">
        admin_status,
      </if>
      <if test="adminJob != null">
        admin_job,
      </if>
      <if test="adminRealName != null">
        admin_real_name,
      </if>
      <if test="adminPhone != null">
        admin_phone,
      </if>
      <if test="adminDep != null">
        admin_dep,
      </if>
      <if test="isDepManager != null">
        is_dep_manager,
      </if>
      <if test="adminLastTime != null">
        admin_last_time,
      </if>
      <if test="isDel != null">
        is_del,
      </if>
      <if test="createTime != null">
        create_time,
      </if>
      <if test="updateTime != null">
        update_time,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides=",">
      <if test="id != null">
        #{id,jdbcType=BIGINT},
      </if>
      <if test="adminName != null">
        #{adminName,jdbcType=VARCHAR},
      </if>
      <if test="adminPassword != null">
        #{adminPassword,jdbcType=VARCHAR},
      </if>
      <if test="adminStatus != null">
        #{adminStatus,jdbcType=TINYINT},
      </if>
      <if test="adminJob != null">
        #{adminJob,jdbcType=VARCHAR},
      </if>
      <if test="adminRealName != null">
        #{adminRealName,jdbcType=VARCHAR},
      </if>
      <if test="adminPhone != null">
        #{adminPhone,jdbcType=VARCHAR},
      </if>
      <if test="adminDep != null">
        #{adminDep,jdbcType=BIGINT},
      </if>
      <if test="isDepManager != null">
        #{isDepManager,jdbcType=TINYINT},
      </if>
      <if test="adminLastTime != null">
        #{adminLastTime,jdbcType=TIMESTAMP},
      </if>
      <if test="isDel != null">
        #{isDel,jdbcType=BIT},
      </if>
      <if test="createTime != null">
        #{createTime,jdbcType=TIMESTAMP},
      </if>
      <if test="updateTime != null">
        #{updateTime,jdbcType=TIMESTAMP},
      </if>
    </trim>
  </insert>
  <update id="updateByPrimaryKeySelective" parameterType="com.vcooline.crm.common.model.CrmAdmin">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Jul 16 15:20:21 CST 2015.
    -->
    update crm_admin
    <set>
      <if test="adminName != null">
        admin_name = #{adminName,jdbcType=VARCHAR},
      </if>
      <if test="adminPassword != null">
        admin_password = #{adminPassword,jdbcType=VARCHAR},
      </if>
      <if test="adminStatus != null">
        admin_status = #{adminStatus,jdbcType=TINYINT},
      </if>
      <if test="adminJob != null">
        admin_job = #{adminJob,jdbcType=VARCHAR},
      </if>
      <if test="adminRealName != null">
        admin_real_name = #{adminRealName,jdbcType=VARCHAR},
      </if>
      <if test="adminPhone != null">
        admin_phone = #{adminPhone,jdbcType=VARCHAR},
      </if>
      <if test="adminDep != null">
        admin_dep = #{adminDep,jdbcType=BIGINT},
      </if>
      <if test="isDepManager != null">
        is_dep_manager = #{isDepManager,jdbcType=TINYINT},
      </if>
      <if test="adminLastTime != null">
        admin_last_time = #{adminLastTime,jdbcType=TIMESTAMP},
      </if>
      <if test="isDel != null">
        is_del = #{isDel,jdbcType=BIT},
      </if>
      <if test="createTime != null">
        create_time = #{createTime,jdbcType=TIMESTAMP},
      </if>
      <if test="updateTime != null">
        update_time = #{updateTime,jdbcType=TIMESTAMP},
      </if>
    </set>
    where id = #{id,jdbcType=BIGINT}
  </update>
  <update id="updateByPrimaryKey" parameterType="com.vcooline.crm.common.model.CrmAdmin">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Jul 16 15:20:21 CST 2015.
    -->
    update crm_admin
    set admin_name = #{adminName,jdbcType=VARCHAR},
      admin_password = #{adminPassword,jdbcType=VARCHAR},
      admin_status = #{adminStatus,jdbcType=TINYINT},
      admin_job = #{adminJob,jdbcType=VARCHAR},
      admin_real_name = #{adminRealName,jdbcType=VARCHAR},
      admin_phone = #{adminPhone,jdbcType=VARCHAR},
      admin_dep = #{adminDep,jdbcType=BIGINT},
      is_dep_manager = #{isDepManager,jdbcType=TINYINT},
      admin_last_time = #{adminLastTime,jdbcType=TIMESTAMP},
      is_del = #{isDel,jdbcType=BIT},
      create_time = #{createTime,jdbcType=TIMESTAMP},
      update_time = #{updateTime,jdbcType=TIMESTAMP}
    where id = #{id,jdbcType=BIGINT}
  </update>
  
  <select id="getAdminListPage" resultMap="resultMap" parameterType="com.vcooline.crm.common.model.Page">
       SELECT A.ID,A.admin_name,A.admin_real_name,A.admin_status,C.role_name FROM crm_admin A 
           INNER JOIN crm_admin_role B ON A.id = B.admin_id
           INNER JOIN crm_role C ON C.id = B.role_id  
        WHERE 1=1
        
       <if test="page.params.adminRealName != null">
         and A.admin_real_name LIKE '%${page.params.adminRealName}%'
       </if>
       <if test="page.params.adminStatus != null">
         and A.admin_status = #{page.params.adminStatus}
       </if>
       <if test="page.params.role_id != null">
         and C.id = #{page.params.role_id}
       </if>
       and A.is_del = 0 AND B.is_del = 0 AND C.is_del = 0 and C.role_type != 0
       order by A.id desc
  </select>
  
  <select id="selctByAdminNameAndPassword" resultMap="BaseResultMap">
     SELECT A.*,C.role_type from crm_admin A 
		INNER JOIN crm_admin_role B ON A.id= B.admin_id
		INNER JOIN crm_role C ON C.id = B.role_id 
		            WHERE A.admin_name =#{adminName}
		              and A.admin_password=#{adminPassword}
		              and A.admin_status=1 
		              and A.is_del = 0
		              AND C.is_del = 0 
  </select>
  
  <!-- 获取部门下管理员信息(分页) caohuan 2015-07-23 -->
  <select id="selectByAdminDep" resultMap="BaseResultMap" parameterType="com.vcooline.crm.common.model.Page">
     SELECT A.*,B.dep_name FROM crm_admin A 
         INNER JOIN crm_dep B ON A.admin_dep = B.id 
       WHERE A.admin_dep = ${page.params.adminDep}
         and A.is_del = 0 
         order by A.id desc
  </select>
  
  <!-- 获取部门下管理员信息(未分页) caohuan 2015-07-23 -->                        
  <select id="selectAdminByDep" resultMap="BaseResultMap" parameterType="java.lang.Long">
     SELECT <include refid="Base_Column_List"/>
         FROM crm_admin 
       WHERE admin_dep = #{adminDep}
         and is_del = 0 
  </select>
  <!--根据条件查询归属人信息-->
  <select id="getOwerList" parameterType="com.vcooline.crm.common.model.CrmAdmin" resultMap="BaseResultMap">
    SELECT
     <include refid="Base_Column_List"/>
     FROM crm_admin
    WHERE 1=1
    <if test="roleType != 0">
      <if test="isDepManager == 1 and id != null">
       AND id IN (
          SELECT
          cad.id
          FROM
          crm_admin cad
          WHERE
        FIND_IN_SET(
        cad.admin_dep,
        getChildList (#{id})
        )
        )
      </if>
      <if test="isDepManager != 1 and id != null">
       AND id = #{id}
      </if>
    </if>
    AND is_del = 0
    <if test="adminStatus != null">
      AND admin_status = #{adminStatus,jdbcType=BIT}
    </if>

  </select>
  <!--根据真实姓名查询用户-->
  <select id="selectAdminByRealName" parameterType="java.lang.String" resultMap="BaseResultMap">
    SELECT
     <include refid="Base_Column_List"/>
     FROM crm_admin
    WHERE admin_real_name = #{adminRealName}
    AND is_del = 0
    AND  admin_status = 1
  </select>
  
  <!-- 根据id更新管理员部门  caohuan 2015-07-23 -->
  <update id="updateAdminDepById" parameterType="com.vcooline.crm.common.model.CrmAdmin">
      UPDATE crm_admin set 
        <if test="adminDep != null">
            admin_dep = #{adminDep}
        </if>
        WHERE id =#{id}
  </update>
  
  <!-- 根据id软删管理员  caohuan 2015-07-23 -->
  <update id="deleteAdminById" parameterType="java.lang.Long">
       UPDATE crm_admin set id_del = 1
        WHERE id =#{id}
  </update>
  
  <update id="updateAdminById" parameterType="com.vcooline.crm.common.model.CrmAdmin">
      update crm_admin set 
        <if test="adminRealName != null">
            admin_real_name = #{adminRealName},
        </if>
        <if test="adminPassword != null">
            admin_password = #{adminPassword},
        </if>
        <if test="updateTime != null">
            update_time = #{updateTime}
        </if>
        WHERE id =#{id}
  </update>
  
  <update id="setIsDepManagerToFalse" parameterType="com.vcooline.crm.common.model.CrmAdmin">
       update crm_admin set is_dep_manager = 0 where admin_dep = #{adminDep} and is_dep_manager = 1;
  </update>
  
  <update id="setIsDepManager" parameterType="com.vcooline.crm.common.model.CrmAdmin">
      update crm_admin set is_dep_manager = #{isDepManager},update_time = #{updateTime} where id=#{id};
   </update>
</mapper>